<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©</title>
<style>
body {
  font-family: "Cairo", Arial, sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f9f9f9;
}
h1, h2 { margin: 0; }

button {
  padding: 10px 18px;
  font-size: 16px;
  cursor: pointer;
  margin: 6px;
  border: none;
  border-radius: 6px;
  background-color: #1D70B8;
  color: white;
  transition: 0.2s;
}
button:hover { background-color: #155f96; }

#invoiceContainer { display:none; margin-top:30px; }
#invoiceSummaryContainer { display:none; margin-top:20px; }

.qty-input {
  width: 45px;
  text-align: center;
  font-size: 16px;
  border: 1px solid #ccc;
  border-radius: 4px;
  margin: 0 6px;
}

#totalBox {
  display:none;
  background-color:#850000;
  color:white;
  font-weight:bold;
  font-size:20px;
  text-align:center;
  padding:15px;
  margin:20px auto;
  width:60%;
  border-radius:10px;
}

input[type="text"] {
  padding:8px;
  font-size:16px;
  width:60%;
  margin:10px auto;
  display:block;
  border-radius:6px;
  border:1px solid #ccc;
}

table {
  border-collapse: collapse;
  width: 90%;
  margin: 20px auto;
  background-color: white;
  box-shadow: 0 0 5px rgba(0,0,0,0.1);
}
th, td {
  border: 1px solid #ddd;
  padding: 10px;
  text-align: center;
}
th {
  background-color: #e9f2fa;
  font-weight: bold;
}
td button {
  background-color: #28a745;
}
td button:hover {
  background-color: #1e7e34;
}
.removeBtn {
  background-color: #c82333 !important;
}
.removeBtn:hover {
  background-color: #a71d2a !important;
}
</style>
</head>
<body>

<!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
<div style="background-color:#1D70B8; color:white; text-align:center; padding:15px 0; margin-bottom:20px;">
  <h1>Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© ğŸ’°</h1>
</div>

<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
<div style="text-align:center; margin-bottom:30px;">
  <button id="goProductsBtn" style="display:block; margin:10px auto;">Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
  <button id="createInvoiceBtn" style="display:block; margin:10px auto;">Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ’°</button>
</div>

<!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
<div id="invoiceInfo" style="display:none; text-align:center;">
  <input type="text" id="clientName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
  <div id="invoiceDateTime" style="font-size:17px; color:#555;"></div>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
<div id="invoiceSummaryContainer">
  <h2 style="text-align:center;">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©</h2>
  <table id="invoiceSummaryTable">
    <thead>
      <tr>
        <th>Ø§Ù„ØµÙ†Ù</th>
        <th>Ø§Ù„Ø³Ø¹Ø±</th>
        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="totalBox">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0</div>

<!-- Ø²Ø± Ø§Ù„Ø­ÙØ¸ -->
<div id="saveArea" style="display:none; text-align:center;">
  <button id="saveInvoiceBtn" style="background-color:#850000;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
<div id="invoiceContainer"></div>

<script>
const createInvoiceBtn = document.getElementById('createInvoiceBtn');
const goProductsBtn = document.getElementById('goProductsBtn');
const invoiceContainer = document.getElementById('invoiceContainer');
const invoiceSummaryContainer = document.getElementById('invoiceSummaryContainer');
const invoiceSummaryTable = document.getElementById('invoiceSummaryTable').querySelector('tbody');
const totalBox = document.getElementById('totalBox');
const clientNameInput = document.getElementById('clientName');
const invoiceInfo = document.getElementById('invoiceInfo');
const saveArea = document.getElementById('saveArea');
const saveInvoiceBtn = document.getElementById('saveInvoiceBtn');
const dateTimeDiv = document.getElementById('invoiceDateTime');
let invoiceTable, precomputedText = [];

// Ø²Ø± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª
goProductsBtn.addEventListener('click', () => {
  window.location.href = 'https://ramezatatra9.github.io/ramez/product.html';
});

// ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¨Ø­Ø«
function debounce(func, delay) {
  let timeout;
  return function(...args){
    clearTimeout(timeout);
    timeout = setTimeout(()=> func.apply(this,args), delay);
  }
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
createInvoiceBtn.addEventListener('click', async () => {
  invoiceInfo.style.display = 'block';
  dateTimeDiv.innerText = "ğŸ•’ " + new Date().toLocaleString();

  if(invoiceContainer.innerHTML.trim() === '') {
    try {
      const response = await fetch('https://ramezatatra9.github.io/ramez/product.html');
      if(!response.ok) throw new Error('ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª');
      const html = await response.text();

      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      invoiceTable = tempDiv.querySelector('#priceTable');
      if(!invoiceTable) throw new Error('Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ product.html');

      invoiceContainer.appendChild(invoiceTable);
      invoiceContainer.style.display = 'block';
      invoiceSummaryContainer.style.display = 'block';
      saveArea.style.display = 'block';
      totalBox.style.display = 'block';

      setupInvoiceFunctions();
    } catch(err) {
      invoiceContainer.innerHTML = `<p style="color:red; text-align:center;">Ø®Ø·Ø£: ${err.message}</p>`;
    }
  } else {
    invoiceContainer.style.display = 'block';
    invoiceSummaryContainer.style.display = 'block';
    saveArea.style.display = 'block';
    totalBox.style.display = 'block';
  }
});

// Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„
function setupInvoiceFunctions(){
  const invoiceBody = invoiceTable.querySelector('tbody');
  const rows = Array.from(invoiceBody.rows);

  rows.forEach(row=>{
    if(!row.querySelector('.qty-input')){
      const qtyCell = row.insertCell(-1);
      const box = document.createElement('div');
      box.style.display='flex';
      box.style.alignItems='center';
      box.style.justifyContent='center';

      const minusBtn = document.createElement('button'); minusBtn.innerText='-';
      const qtyInput = document.createElement('input');
      qtyInput.type='text'; qtyInput.value='1';
      qtyInput.readOnly=true; qtyInput.classList.add('qty-input');
      const plusBtn = document.createElement('button'); plusBtn.innerText='+';

      box.appendChild(minusBtn);
      box.appendChild(qtyInput);
      box.appendChild(plusBtn);
      qtyCell.appendChild(box);

      minusBtn.addEventListener('click',()=>{ if(parseInt(qtyInput.value)>1) qtyInput.value--; });
      plusBtn.addEventListener('click',()=>{ qtyInput.value = parseInt(qtyInput.value)+1; });
    }

    if(!row.querySelector('.addBtn')){
      const addCell = row.insertCell(-1);
      const addBtn = document.createElement('button');
      addBtn.innerText='â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©';
      addBtn.classList.add('addBtn');
      addCell.appendChild(addBtn);

      addBtn.addEventListener('click', ()=>{
        const name = row.cells[1].innerText;
        const price = parseFloat(row.cells[2].innerText.replace(/,/g,''))||0;
        const qty = parseInt(row.querySelector('.qty-input').value);
        addToInvoice(name, price, qty);
      });
    }
  });

  // Ø§Ù„Ø¨Ø­Ø«
  const searchInput = document.createElement('input');
  searchInput.type='text'; searchInput.placeholder='Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙ†Ù ğŸ”';
  searchInput.style.display='block';
  searchInput.style.margin='10px auto';
  searchInput.style.width='60%';
  invoiceContainer.prepend(searchInput);

  const invoiceBodyRows = Array.from(invoiceBody.rows);
  precomputedText = invoiceBodyRows.map(row=>Array.from(row.cells).map(td=>td.innerText.toLowerCase()).join(' '));

  searchInput.addEventListener('input', debounce(()=>{
    const query = searchInput.value.toLowerCase().trim();
    invoiceBodyRows.forEach((row,i)=>{
      row.style.display = query === '' || precomputedText[i].includes(query) ? '' : 'none';
    });
  }, 200));
}

// Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ù„Ù„ÙØ§ØªÙˆØ±Ø©
function addToInvoice(name, price, qty){
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${name}</td><td>${price}</td><td>${qty}</td><td>${(price*qty).toLocaleString()}</td>
                  <td><button class="removeBtn">Ø­Ø°Ù</button></td>`;
  invoiceSummaryTable.appendChild(tr);

  tr.querySelector('.removeBtn').addEventListener('click', ()=>{
    tr.remove();
    updateTotal();
  });

  updateTotal();
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
function updateTotal(){
  let total = 0;
  Array.from(invoiceSummaryTable.rows).forEach(row=>{
    total += parseFloat(row.cells[3].innerText.replace(/,/g,'')) || 0;
  });
  totalBox.innerText = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toLocaleString()} ğŸ’°`;
}

// Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨ØµÙŠØºØ© HTML
saveInvoiceBtn.addEventListener('click', ()=>{
  const client = clientNameInput.value || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
  const date = new Date().toLocaleString();

  let tableHTML = `
  <table border="1" cellspacing="0" cellpadding="8" style="border-collapse:collapse; width:100%; text-align:center;">
    <thead style="background:#e9f2fa;">
      <tr>
        <th>Ø§Ù„ØµÙ†Ù</th>
        <th>Ø§Ù„Ø³Ø¹Ø±</th>
        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
      </tr>
    </thead>
    <tbody>
  `;

  Array.from(invoiceSummaryTable.rows).forEach(row=>{
    tableHTML += `<tr>
      <td>${row.cells[0].innerText}</td>
      <td>${row.cells[1].innerText}</td>
      <td>${row.cells[2].innerText}</td>
      <td>${row.cells[3].innerText}</td>
    </tr>`;
  });

  tableHTML += '</tbody></table>';

  const invoiceHTML = `
  <!DOCTYPE html>
  <html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8">
    <title>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ ${client}</title>
    <style>
      body { font-family: "Cairo", Arial, sans-serif; padding:20px; background:#f9f9f9; }
      h2 { text-align:center; color:#1D70B8; }
      p { font-size:16px; text-align:center; }
      table { border-collapse: collapse; width:100%; margin-top:20px; background:white; }
      th, td { border:1px solid #ddd; padding:10px; text-align:center; }
      th { background-color:#e9f2fa; font-weight:bold; }
      #totalBox { background-color:#850000; color:white; font-weight:bold; font-size:18px; text-align:center; padding:10px; margin:20px auto; width:50%; border-radius:6px; }
    </style>
  </head>
  <body>
    <h2>ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</h2>
    <p>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: ${client}</p>
    <p>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª: ${date}</p>
    ${tableHTML}
    <div id="totalBox">${totalBox.innerText}</div>
  </body>
  </html>
  `;

  const blob = new Blob([invoiceHTML], {type: "text/html"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `ÙØ§ØªÙˆØ±Ø©_${client}_${Date.now()}.html`;
  a.click();
});
</script>
</body>
</html>
