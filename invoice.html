<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©</title>
<style>
body { font-family: Arial; margin:20px; padding:0; }
h1,h2,h3 { margin:0; }
button { cursor:pointer; font-size:16px; padding:6px 12px; margin:5px; }
#invoiceContainer { display:none; margin-top:20px; }
#invoiceSummaryContainer { display:none; margin-top:20px; }
#totalBox { font-weight:bold; text-align:center; color:white; background:#850000; padding:10px; margin:20px auto; width:300px; border-radius:5px; display:none;}
.qty-input { width:40px; text-align:center; }
table { border-collapse: collapse; width:100%; margin-top:10px; }
th, td { border:1px solid #333; padding:8px; text-align:center; }
th { background-color:#f2f2f2; }
#searchInput { display:block; margin:10px auto; width:60%; padding:6px; font-size:16px; }
#buttonsContainer { text-align:center; margin-bottom:30px; }
#buttonsContainer button { display:block; margin:10px auto; min-width:200px; }
#customerName { display:block; margin:10px auto; width:60%; padding:6px; font-size:16px; }
</style>
</head>
<body>

<!-- Ù…Ø³ØªØ·ÙŠÙ„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
<div style="background-color:#1D70B8; color:white; text-align:center; padding:15px 0; margin-bottom:20px;">
  <h1>Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© ğŸ’°</h1>
</div>

<!-- Ø®Ø§Ù†Ø© Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
<input type="text" id="customerName" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù‡Ù†Ø§">

<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
<div id="buttonsContainer">
  <button id="goProductsBtn">Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
  <button id="createInvoiceBtn">Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ’°</button>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø© -->
<div id="invoiceSummaryContainer">
  <h2 style="text-align:center;">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©</h2>
  <table id="invoiceSummaryTable">
    <thead>
      <tr>
        <th>Ø§Ù„ØµÙ†Ù</th>
        <th>Ø§Ù„Ø³Ø¹Ø±</th>
        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="totalBox"></div>

<!-- Ø­Ø§ÙˆÙŠØ© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ© -->
<div id="invoiceContainer"></div>

<!-- Ø²Ø± Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
<div style="text-align:center; margin-top:20px;">
  <button id="saveInvoiceBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
</div>

<script>
const createInvoiceBtn = document.getElementById('createInvoiceBtn');
const goProductsBtn = document.getElementById('goProductsBtn');
const invoiceContainer = document.getElementById('invoiceContainer');
const invoiceSummaryContainer = document.getElementById('invoiceSummaryContainer');
const invoiceSummaryTable = document.getElementById('invoiceSummaryTable').querySelector('tbody');
const totalBox = document.getElementById('totalBox');
const customerNameInput = document.getElementById('customerName');

let invoiceTable;
let precomputedText = [];

// --- Ø²Ø± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª ---
goProductsBtn.addEventListener('click', () => {
  window.location.href = 'https://ramezatatra9.github.io/ramez/product.html';
});

// --- Ø¯Ø§Ù„Ø© debounce Ù„ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¨Ø­Ø« ---
function debounce(func, delay) {
  let timeout;
  return function(...args){
    clearTimeout(timeout);
    timeout = setTimeout(()=> func.apply(this,args), delay);
  }
}

// --- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ¬Ù„Ø¨ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ---
createInvoiceBtn.addEventListener('click', async () => {
  if(invoiceContainer.innerHTML.trim() === '') {
    try {
      const response = await fetch('https://ramezatatra9.github.io/ramez/product.html');
      if(!response.ok) throw new Error('ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª');
      const html = await response.text();

      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      invoiceTable = tempDiv.querySelector('#priceTable');
      if(!invoiceTable) throw new Error('Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ product.html');

      invoiceContainer.appendChild(invoiceTable);
      invoiceContainer.style.display = 'block';
      invoiceSummaryContainer.style.display = 'block';
      totalBox.style.display = 'block';

      setupInvoiceFunctions();

    } catch(err) {
      invoiceContainer.innerHTML = `<p style="color:red; text-align:center;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„ØµÙØ­Ø©: ${err.message}</p>`;
    }
  } else {
    invoiceContainer.style.display = 'block';
    invoiceSummaryContainer.style.display = 'block';
    totalBox.style.display = 'block';
  }
});

// --- Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ --- 
function setupInvoiceFunctions(){
  const invoiceBody = invoiceTable.querySelector('tbody');
  const rows = Array.from(invoiceBody.rows);

  // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
  rows.forEach(row=>{
    if(!row.querySelector('.qty-input')){
      const qtyCell = row.insertCell(-1);
      const minusBtn = document.createElement('button'); minusBtn.innerText='-';
      const qtyInput = document.createElement('input'); qtyInput.type='text'; qtyInput.value='1';
      qtyInput.readOnly=true; qtyInput.classList.add('qty-input');
      const plusBtn = document.createElement('button'); plusBtn.innerText='+';
      qtyCell.appendChild(minusBtn); qtyCell.appendChild(qtyInput); qtyCell.appendChild(plusBtn);

      minusBtn.addEventListener('click',()=>{ if(parseInt(qtyInput.value)>1) qtyInput.value--; });
      plusBtn.addEventListener('click',()=>{ qtyInput.value = parseInt(qtyInput.value)+1; });
    }

    if(!row.querySelector('.addBtn')){
      const addCell = row.insertCell(-1);
      const addBtn = document.createElement('button');
      addBtn.innerText='Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©'; addBtn.classList.add('addBtn'); addCell.appendChild(addBtn);
      addBtn.addEventListener('click', ()=>{
        const name = row.cells[1].innerText;
        const price = parseFloat(row.cells[2].innerText.replace(/,/g,''))||0;
        const qty = parseInt(row.querySelector('.qty-input').value);
        addToInvoice(name, price, qty);
      });
    }
  });

  // --- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø­Ø« ---
  const searchInput = document.createElement('input');
  searchInput.type='text'; searchInput.placeholder='Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙ†Ù ğŸ”';
  searchInput.id='searchInput';
  invoiceContainer.prepend(searchInput);

  const resultCount = document.createElement('div'); resultCount.id='resultCount';
  resultCount.style.textAlign='center';
  invoiceContainer.prepend(resultCount);

  precomputedText = rows.map(row=>Array.from(row.cells).map(td=>td.innerText.toLowerCase()).join(' '));

  searchInput.addEventListener('input', debounce(()=>{
    let matches = 0;
    rows.forEach((row,i)=>{
      if(searchInput.value.trim() === '' || searchInput.value.toLowerCase().split(/\s+/).every(w=>precomputedText[i].includes(w))){
        row.style.display=''; matches++;
      } else row.style.display='none';
    });
    resultCount.innerText = matches>0?`Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${matches}`:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© ğŸ˜•';
  }, 200));
}

// --- Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø© ---
function addToInvoice(name, price, qty){
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${name}</td><td>${price}</td><td>${qty}</td><td>${(price*qty).toLocaleString()}</td>
                  <td><button class="removeBtn">Ø­Ø°Ù</button></td>`;
  invoiceSummaryTable.appendChild(tr);

  tr.querySelector('.removeBtn').addEventListener('click', ()=>{
    tr.remove();
    updateTotal();
  });

  updateTotal();
}

// --- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ---
function updateTotal(){
  let total = 0;
  Array.from(invoiceSummaryTable.rows).forEach(row=>{
    total += parseFloat(row.cells[3].innerText.replace(/,/g,'')) || 0;
  });
  totalBox.innerText = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toLocaleString()}`;
}

// --- Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ---
document.getElementById('saveInvoiceBtn').addEventListener('click', () => {
  const rows = Array.from(invoiceSummaryTable.rows);
  if (rows.length === 0) {
    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ğŸ˜…');
    return;
  }

  const customerName = customerNameInput.value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  const now = new Date();
  const dateTime = now.toLocaleString();

  let tableHTML = `
  <table border="1" cellspacing="0" cellpadding="8" style="border-collapse:collapse; width:100%; text-align:center;">
    <thead style="background:#f2f2f2;">
      <tr>
        <th>Ø§Ù„ØµÙ†Ù</th>
        <th>Ø§Ù„Ø³Ø¹Ø±</th>
        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
      </tr>
    </thead>
    <tbody>
  `;

  rows.forEach(row => {
    const cells = row.cells;
    tableHTML += `<tr>
      <td>${cells[0].innerText}</td>
      <td>${cells[1].innerText}</td>
      <td>${cells[2].innerText}</td>
      <td>${cells[3].innerText}</td>
    </tr>`;
  });

  tableHTML += '</tbody></table>';
  const total = totalBox.innerText || 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0';

  const invoiceHTML = `
  <!DOCTYPE html>
  <html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8">
    <title>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ ${customerName}</title>
    <style>
      body { font-family: Arial; padding:20px; direction: rtl; }
      table { border-collapse: collapse; width:100%; }
      th, td { border:1px solid #333; padding:8px; text-align:center; }
      th { background-color:#e9f2fa; }
      h2 { text-align:center; color:#1D70B8; }
      h3 { text-align:center; color:#850000; margin-top:20px; }
    </style>
  </head>
  <body>
    <h2>ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</h2>
    <p><strong>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${customerName}</p>
    <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª:</strong> ${dateTime}</p>
    ${tableHTML}
    <h3>${total}</h3>
  </body>
  </html>
  `;

  const blob = new Blob([invoiceHTML], { type: 'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `ÙØ§ØªÙˆØ±Ø©_${customerName}_${Date.now()}.html`;
  a.click();
});
</script>

</body>
</html>
