<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©</title>
<style>
body { font-family: Arial; margin: 40px; padding: 20px; }
h1 { text-align:center; }
button { padding:8px 12px; font-size:16px; cursor:pointer; margin:5px; }
#invoiceContainer { display:none; margin-top:20px; }
#resultCount { text-align:center; margin-top:10px; font-weight:bold; color:#444; }
.qty-input { width:40px; text-align:center; }
</style>
</head>
<body>

<h1>Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©</h1>

<button id="createInvoiceBtn">Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ’°</button>

<div id="invoiceContainer"></div>

<div id="total" style="font-weight:bold; margin-top:10px; text-align:right;"></div>

<script>
const createInvoiceBtn = document.getElementById('createInvoiceBtn');
const invoiceContainer = document.getElementById('invoiceContainer');
const totalDiv = document.getElementById('total');

let invoiceTable; // Ø³ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¬Ù„Ø¨

// Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
createInvoiceBtn.addEventListener('click', async () => {
  if(invoiceContainer.innerHTML.trim() === '') {
    try {
      const response = await fetch('product.html'); // Ø¬Ù„Ø¨ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
      if(!response.ok) throw new Error('ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª');
      const html = await response.text();

      // Ù†Ø¶Ø¹ html ÙÙŠ div Ù…Ø¤Ù‚Øª Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙ‚Ø·
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      invoiceTable = tempDiv.querySelector('#priceTable');
      
      if(!invoiceTable) throw new Error('Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ product.html');

      // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ ØµÙØ­Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
      invoiceContainer.appendChild(invoiceTable);
      invoiceContainer.style.display = 'block';

      // ØªÙØ¹ÙŠÙ„ ÙƒÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„Ø¨Ø­Ø«
      setupInvoiceFunctions();

    } catch(err) {
      invoiceContainer.innerHTML = `<p style="color:red;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„ØµÙØ­Ø©: ${err.message}</p>`;
    }
  } else {
    invoiceContainer.style.display = 'block';
  }
});

// --- ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ ÙˆØ£Ø²Ø±Ø§Ø± Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ© ---
function setupInvoiceFunctions() {
  const searchInput = document.createElement('input');
  searchInput.type = 'text';
  searchInput.placeholder = 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙ†Ù ğŸ”';
  searchInput.style.marginBottom = '10px';
  invoiceContainer.prepend(searchInput);

  const resultCount = document.createElement('div');
  resultCount.id = 'resultCount';
  invoiceContainer.prepend(resultCount);

  const invoiceBody = invoiceTable.querySelector('tbody');

  // Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„ÙƒÙ„ ØµÙ
  Array.from(invoiceBody.rows).forEach(row => {
    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ø§Ù„ÙƒÙ…ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
    if(!row.querySelector('.qty-input')){
      const qtyCell = row.insertCell(-1);
      const minusBtn = document.createElement('button');
      minusBtn.innerText = '-';
      const qtyInput = document.createElement('input');
      qtyInput.type = 'text';
      qtyInput.value = '1';
      qtyInput.readOnly = true;
      qtyInput.classList.add('qty-input');
      const plusBtn = document.createElement('button');
      plusBtn.innerText = '+';
      qtyCell.appendChild(minusBtn);
      qtyCell.appendChild(qtyInput);
      qtyCell.appendChild(plusBtn);

      minusBtn.addEventListener('click', ()=> { if(parseInt(qtyInput.value)>1) qtyInput.value--; });
      plusBtn.addEventListener('click', ()=> { qtyInput.value = parseInt(qtyInput.value)+1; });
    }

    // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
    if(!row.querySelector('.addBtn')){
      const addCell = row.insertCell(-1);
      const btn = document.createElement('button');
      btn.innerText = 'Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©';
      btn.classList.add('addBtn');
      addCell.appendChild(btn);
      btn.addEventListener('click', ()=>{
        const name = row.cells[1].innerText;
        const price = parseFloat(row.cells[2].innerText.replace(/,/g,'')) || 0;
        const qty = parseInt(row.querySelector('.qty-input').value);
        addToInvoice(name, price, qty);
      });
    }
  });

  // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø«
  searchInput.addEventListener('input', ()=> smartSearch(searchInput, resultCount));
}

// --- Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ ---
function smartSearch(inputEl, resultCountEl){
  const input = inputEl.value.trim().toLowerCase();
  const rows = Array.from(invoiceTable.querySelectorAll('tbody tr'));
  let matches = 0;
  rows.forEach(row=>{
    const rowText = Array.from(row.cells).map(td=>td.innerText.toLowerCase()).join(' ');
    if(input === '' || input.split(/\s+/).every(word=>rowText.includes(word))){
      row.style.display = '';
      matches++;
    } else row.style.display = 'none';
  });
  resultCountEl.innerText = matches>0?`Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${matches}`:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© ğŸ˜•';
}

// --- Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø© ---
function addToInvoice(name, price, qty){
  let invoiceSummary = document.getElementById('invoiceSummary');
  if(!invoiceSummary){
    invoiceSummary = document.createElement('table');
    invoiceSummary.id = 'invoiceSummary';
    invoiceSummary.style.width = '100%';
    invoiceSummary.style.borderCollapse = 'collapse';
    invoiceSummary.innerHTML = `<thead><tr>
      <th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
    </tr></thead><tbody></tbody>`;
    invoiceContainer.appendChild(invoiceSummary);
  }
  const tbody = invoiceSummary.querySelector('tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${name}</td><td>${price}</td><td>${qty}</td><td>${(price*qty).toLocaleString()}</td>`;
  tbody.appendChild(tr);

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
  let total = 0;
  Array.from(tbody.rows).forEach(r=>{
    total += parseFloat(r.cells[3].innerText.replace(/,/g,''));
  });
  totalDiv.innerText = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toLocaleString()}`;
}
</script>

</body>
</html>
