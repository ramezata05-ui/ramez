<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</title>
<style>
body { font-family: Arial; margin: 40px; padding: 20px; }
h1 { text-align:center; }
button { padding:8px 12px; font-size:16px; cursor:pointer; margin:5px; }
#invoiceContainer { display:none; margin-top:20px; }
#total { font-weight:bold; margin-top:10px; text-align:right; }
.qty-input { width:40px; text-align:center; }
#resultCount { text-align:center; margin-top:10px; font-weight:bold; color:#444; }
table { border-collapse: collapse; width:100%; margin-top:10px; }
th, td { border:1px solid #333; padding:8px; text-align:right; }
th { background-color:#f2f2f2; }
</style>
</head>
<body>

<h1>Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©</h1>
<button id="createInvoiceBtn">Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ’°</button>

<div id="invoiceContainer"></div>
<div id="total"></div>

<script>
const createInvoiceBtn = document.getElementById('createInvoiceBtn');
const invoiceContainer = document.getElementById('invoiceContainer');
const totalDiv = document.getElementById('total');
let invoiceTable, invoiceSummary;
let precomputedText = []; // Ù„ØªØ®Ø²ÙŠÙ† Ù†ØµÙˆØµ Ø§Ù„ØµÙÙˆÙ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹

// --- Ø¯Ø§Ù„Ø© debounce Ù„ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¨Ø­Ø« ---
function debounce(func, delay) {
  let timeout;
  return function(...args){
    clearTimeout(timeout);
    timeout = setTimeout(()=> func.apply(this,args), delay);
  }
}

// --- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ---
createInvoiceBtn.addEventListener('click', async () => {
  if(invoiceContainer.innerHTML.trim() === '') {
    try {
      const response = await fetch('product.html');
      if(!response.ok) throw new Error('ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª');
      const html = await response.text();

      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      invoiceTable = tempDiv.querySelector('#priceTable');
      if(!invoiceTable) throw new Error('Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ product.html');

      invoiceContainer.appendChild(invoiceTable);
      invoiceContainer.style.display = 'block';

      setupInvoiceFunctions();

    } catch(err) {
      invoiceContainer.innerHTML = `<p style="color:red;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„ØµÙØ­Ø©: ${err.message}</p>`;
    }
  } else {
    invoiceContainer.style.display = 'block';
  }
});

// --- Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ --- 
function setupInvoiceFunctions(){
  const invoiceBody = invoiceTable.querySelector('tbody');
  const rows = Array.from(invoiceBody.rows);

  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
  rows.forEach(row=>{
    // Ø¹Ù…ÙˆØ¯ Ø§Ù„ÙƒÙ…ÙŠØ©
    if(!row.querySelector('.qty-input')){
      const qtyCell = row.insertCell(-1);
      const minusBtn = document.createElement('button'); minusBtn.innerText='-';
      const qtyInput = document.createElement('input'); qtyInput.type='text'; qtyInput.value='1';
      qtyInput.readOnly=true; qtyInput.classList.add('qty-input');
      const plusBtn = document.createElement('button'); plusBtn.innerText='+';
      qtyCell.appendChild(minusBtn); qtyCell.appendChild(qtyInput); qtyCell.appendChild(plusBtn);

      minusBtn.addEventListener('click',()=>{ if(parseInt(qtyInput.value)>1) qtyInput.value--; });
      plusBtn.addEventListener('click',()=>{ qtyInput.value = parseInt(qtyInput.value)+1; });
    }

    // Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    if(!row.querySelector('.addBtn')){
      const addCell = row.insertCell(-1);
      const addBtn = document.createElement('button');
      addBtn.innerText='Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©'; addBtn.classList.add('addBtn'); addCell.appendChild(addBtn);
      addBtn.addEventListener('click', ()=>{
        const name = row.cells[1].innerText;
        const price = parseFloat(row.cells[2].innerText.replace(/,/g,''))||0;
        const qty = parseInt(row.querySelector('.qty-input').value);
        addToInvoice(name, price, qty);
      });
    }
  });

  // --- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø­Ø« ---
  const searchInput = document.createElement('input');
  searchInput.type='text'; searchInput.placeholder='Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙ†Ù ğŸ”';
  invoiceContainer.prepend(searchInput);
  const resultCount = document.createElement('div'); resultCount.id='resultCount';
  invoiceContainer.prepend(resultCount);

  // Ø­ÙØ¸ Ù†ØµÙˆØµ Ø§Ù„ØµÙÙˆÙ Ù…Ø³Ø¨Ù‚Ø§Ù‹
  precomputedText = rows.map(row=>Array.from(row.cells).map(td=>td.innerText.toLowerCase()).join(' '));

  // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹ Ù…Ø¹ debounce
  searchInput.addEventListener('input', debounce(()=>{
    let matches = 0;
    rows.forEach((row,i)=>{
      if(searchInput.value.trim() === '' || searchInput.value.toLowerCase().split(/\s+/).every(w=>precomputedText[i].includes(w))){
        row.style.display=''; matches++;
      } else row.style.display='none';
    });
    resultCount.innerText = matches>0?`Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${matches}`:'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© ğŸ˜•';
  }, 200));
}

// --- Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø© ---
function addToInvoice(name, price, qty){
  if(!invoiceSummary){
    invoiceSummary = document.createElement('table');
    invoiceSummary.style.width='100%'; invoiceSummary.style.borderCollapse='collapse';
    invoiceSummary.innerHTML=`<thead><tr>
      <th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
    </tr></thead><tbody></tbody>`;
    invoiceContainer.appendChild(invoiceSummary);
  }

  const tbody = invoiceSummary.querySelector('tbody');
  const tr = document.createElement('tr');
  tr.innerHTML=`<td>${name}</td><td>${price}</td><td>${qty}</td><td>${(price*qty).toLocaleString()}</td>`;
  tbody.appendChild(tr);

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
  let total = 0;
  Array.from(tbody.rows).forEach(r=>{ total+=parseFloat(r.cells[3].innerText.replace(/,/g,'')); });
  totalDiv.innerText = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toLocaleString()}`;
}
</script>

</body>
</html>
